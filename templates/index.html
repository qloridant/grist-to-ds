<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Modification de labels Grist -> DS</title>
    <!-- DSFR CSS (CDN). Adjust version if you want a pinned release. -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.0/dist/dsfr.min.css"
    />

    <style>
      body {
        font-family: "Marianne", Arial, sans-serif;
        padding: 1rem;
      }
      .label-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-top: 1rem;
      }

      /* Spinner centr√© */
      .spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 3rem;
        width: 3rem;
        margin: 2rem auto;
      }

      .spinner::after {
        content: "";
        width: 2.5rem;
        height: 2.5rem;
        border: 3px solid #ccc;
        border-top-color: #000091; /* couleur bleue DSFR */
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="fr">
    <h3 class="fr-h5">
      Appliquer le label au dossier <span id="idDossier"></span> dans D√©marches
      Simplifi√©es
    </h3>
    <div id="labelContainer" class="label-buttons"></div>
    <div
      id="error-message"
      style="
        display: none;
        padding: 10px 15px;
        margin-top: 10px;
        border: 1px solid #ba2b1e;
        background-color: #ffd8d2;
        color: #d0270a;
        border-radius: 4px;
        font-size: 0.95rem;
      "
    ></div>
    <div
      id="sucess-message"
      style="
        display: none;
        padding: 10px 15px;
        margin-top: 10px;
        border: 1px solid #27ae60;
        background-color: #e9f9ef;
        color: #1e7e34;
        border-radius: 4px;
        font-size: 0.95rem;
      "
    ></div>

    <!-- DSFR JS (CDN) and initialization -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.0/dist/dsfr.umd.min.js"></script> -->
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script>
      // if (window.dsfr) window.dsfr.init();
    </script>

    <script>
      grist.ready({ requiredAccess: "full" });

      const labelTable = "LABELS";
      const dossiersTableName = "Demarche_128651_dossiers";

      // const docId = document.getElementById('docId').value;

      const sendToDS = async (docId, labelId, exists) => {
        console.log("IN DS");
        const query = !exists
          ? `mutation DossierAjouterLabel {
          dossierAjouterLabel(
            input: { dossierId: "${docId}", labelId: "${labelId}" }
            ) {
              clientMutationId
            }
          }`
          : `mutation DossierSupprimerLabel {
          dossierSupprimerLabel(
            input: { dossierId: "${docId}", labelId: "${labelId}" }
            ) {
              clientMutationId
            }
          }`;

        try {
          const res = await fetch("/create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ query }),
          });
          const data = await res.json();
          if (data?.errors?.length > 0) {
            throw new Error(data.errors[0].message);
          }
        } catch (e) {
          console.error("Response error from external API:", e);
          throw e;
        }
      };

      function showSpinner(container) {
        container.innerHTML = '<div class="spinner"></div>';
      }

      function hideSpinner(container) {
        const spinner = container.querySelector(".spinner");
        if (spinner) spinner.remove();
      }

      // Fonction pour charger la liste des labels (table LABELS)
      async function loadLabels() {
        try {
          const tableData = await grist.docApi.fetchTable(labelTable);
          const labels = tableData?.Label || tableData?.name || [];
          const ids = tableData?.Id_DS || tableData?.id || [];
          return Array.isArray(labels) && Array.isArray(ids)
            ? labels.map((label, index) => ({ id: ids[index], name: label }))
            : [];
        } catch (err) {
          console.error("Erreur lors du chargement des labels :", err);
          return [];
        }
      }

      // Normalise les cha√Ænes
      function normalize(str) {
        return String(str)
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/["'\[\]]/g, "")
          .trim()
          .toLowerCase();
      }

      // Transforme le contenu de Label_names en tableau
      function parseLabelNames(raw) {
        if (!raw) return [];
        const str = String(raw)
          .replace(/["'\[\]]/g, "")
          .trim();
        if (!str) return [];
        return str
          .split(/\s*,\s*/)
          .map(normalize)
          .filter(Boolean);
      }

      // V√©rifie si un label est pr√©sent
      function hasLabel(rawLabelNames, label) {
        const parsed = parseLabelNames(rawLabelNames);
        const normalizedLabel = normalize(label);
        return parsed.includes(normalizedLabel);
      }

      // Mise √† jour de la colonne label_names
      async function updateDossierLabel(dossierId, label, action) {
        try {
          const dossiersTable = await grist.docApi.fetchTable(
            dossiersTableName
          );
          const rowIds = dossiersTable.id; //id de ligne dossier
          const dossierIds = dossiersTable.dossier_id; //id de colonne dossier
          const labels = dossiersTable.label_names; //variable colonne label

          const index = dossierIds.findIndex((id) => id == dossierId);
          if (index === -1) {
            console.error("‚ö†Ô∏è Dossier non trouv√© :", dossierId);
            return;
          }

          const rowId = rowIds[index];
          const currentValue = labels[index] || ""; //r√©cup√©rer la ligne dossier ainsi label
          const parsed = currentValue
            .split(/\s*,\s*/)
            .map((s) => s.trim())
            .filter(Boolean);

          let newValue;
          if (action === "add") {
            if (!parsed.map(normalize).includes(normalize(label.name))) {
              parsed.push(label.name); // conserver la casse d'origine
            }
            newValue = parsed.join(", ");
          } else {
            const labelNorm = normalize(label.name);
            newValue = parsed
              .filter((l) => normalize(l) !== labelNorm)
              .join(", ");
          }

          await grist.docApi.applyUserActions([
            [
              "UpdateRecord",
              "Demarche_128651_dossiers",
              rowId,
              { label_names: newValue },
            ],
          ]);

          return newValue; // renvoyer la nouvelle valeur pour √©viter re-fetch inutile
        } catch (err) {
          console.error("Erreur lors de la mise √† jour du dossier :", err);
        }
      }

      // Affiche les boutons
      async function displayLabels(selectedRecord) {
        const container = document.getElementById("labelContainer");
        container.innerHTML = "";

        const labels = await loadLabels();

        if (!labels || labels.length === 0) {
          container.innerHTML = "<p>Aucun label trouv√©.</p>";
          return;
        }

        const dossierId = selectedRecord?.Dossier_Lie_Dossier_Id;
        const rawLabelNames = selectedRecord?.Dossier_Lie_Label || "";

        if (!dossierId) {
          container.innerHTML = "<p>Aucun dossier li√© √† ce champ.</p>";
          return;
        }

        labels.forEach((label) => {
          const exists = hasLabel(rawLabelNames, label.name);
          const btn = document.createElement("button");
          btn.classList.add("fr-btn", "fr-btn--sm");

          if (exists) {
            btn.classList.add("fr-btn--secondary");
            btn.textContent = `Supprimer ${label.name}`;
            btn.dataset.action = "remove";
          } else {
            btn.classList.add("fr-btn--primary");
            btn.textContent = `Ajouter ${label.name}`;
            btn.dataset.action = "add";
          }

          btn.addEventListener("click", async (event) => {
            event.stopPropagation();
            // document.getElementById("error-message").style.display = "none";
            // document.getElementById("sucess-message").style.display = "none";

            // D√©sactive tous les boutons pendant le chargement
            const allButtons = container.querySelectorAll("button");
            allButtons.forEach((b) => (b.disabled = true));

            // Affiche la roue de chargement
            showSpinner(container);

            try {
              await sendToDS(
                selectedRecord?.Dossier_Lie_Dossier_Id,
                label.id,
                exists
              );
              // Met √† jour le dossier
              const newValue = await updateDossierLabel(
                dossierId,
                label,
                btn.dataset.action
              );

              // Met √† jour localement les labels
              selectedRecord.Dossier_Lie_Label = newValue;

              // üîÑ Met √† jour **uniquement le bouton cliqu√©** sans tout recharger
              const existsNow = hasLabel(newValue, label.name);
              if (existsNow) {
                btn.classList.remove("fr-btn--primary");
                btn.classList.add("fr-btn--secondary");
                btn.textContent = `Supprimer ${label.name}`;
                btn.dataset.action = "remove";
              } else {
                btn.classList.remove("fr-btn--secondary");
                btn.classList.add("fr-btn--primary");
                btn.textContent = `Ajouter ${label.name}`;
                btn.dataset.action = "add";
              }

              // Display success message
              const successBox = document.getElementById("sucess-message");
              successBox.textContent = `‚úÖ Le label ${label.name} a √©t√© ${
                exists ? "supprim√©" : "ajout√©"
              } avec succ√®s dans d√©marches simplifi√©es`;
              successBox.style.display = "block";
            } catch (err) {
              // Display error message
              const errorBox = document.getElementById("error-message");
              errorBox.textContent =
                "Une erreur est survenue. Le label n'a pas √©t√© mofifi√© dans d√©marches simplifi√©es: " +
                err;
              errorBox.style.display = "block";
            } finally {
              hideSpinner(container);
              allButtons.forEach((b) => (b.disabled = false));
            }
          });

          container.appendChild(btn);
        });
      }

      // avoid the code to go mulitple time in onRecord and display duplicated buttons
      let recordLock = false;
      // Quand un enregistrement est s√©lectionn√©
      grist.onRecord(async (record) => {
        if (recordLock) return;
        recordLock = true;
        const container = document.getElementById("labelContainer");
        if (!record) {
          container.innerHTML = "<p>Aucun champ s√©lectionn√©.</p>";
          recordLock = false;
          return;
        }
        const idDossier = document.getElementById("idDossier");
        idDossier.innerText = record.Dossier_Lie_Dossier_Id;
        document.getElementById("error-message").style.display = "none";
        document.getElementById("sucess-message").style.display = "none";
        await displayLabels(record);
        recordLock = false;
      });
    </script>
  </body>
</html>
